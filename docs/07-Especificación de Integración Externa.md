**Nombre del documento**

`6-IntegracionExterna-BotAsistenciaInternaTelegram.d`

---

## Contenido recomendado

| Nº  | Sección                     | Descripción técnica                                                                                                                                                                                                                                                                                                                                  |
| --- | --------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Propósito                   | Definir las reglas de conexión, autenticación, formato de mensajes, cuotas y manejo de errores para cada servicio externo utilizado por el bot.                                                                                                                                                                                                      |
| 2   | Visión general              | Tabla resumen con servicio, función, protocolo, librería cliente y variable de entorno que almacena la credencial.                                                                                                                                                                                                                                   |
| 3   | Matriz de Integraciones     | Ver <br>**3.1** API Telegram, **3.2** Google Sheets API, **3.3** Google Drive API, **3.4** Gemini API, **3.5** ngrok. Cada subsección incluye: <br>• Endpoint(s) utilizados <br>• Método HTTP <br>• Formato de solicitud <br>• Formato de respuesta <br>• Códigos de error relevantes <br>• Límite de cuota <br>• Estrategia de reintento / back-off |
| 3.1 | API Telegram (webhook)      | - `POST https://api.telegram.org/bot{TOKEN}/setWebhook` <br>- `POST https://api.telegram.org/bot{TOKEN}/sendMessage` <br>Autenticación: TOKEN (header no requerido). <br>JSON ejemplo de webhook entrante y `sendMessage` saliente. <br>Rate-limit: 30 msg/s global, 1 msg/s chat. <br>Reintento: exponencial, 3 intentos máx.                       |
| 3.2 | Google Sheets API           | - `GET https://sheets.googleapis.com/v4/spreadsheets/{id}/values/{range}` <br>Auth: OAuth2 service-account (JWT). <br>Scope: `https://www.googleapis.com/auth/spreadsheets.readonly`. <br>Cuota por proyecto: 100 rps / 100 MB día.                                                                                                                  |
| 3.3 | Google Drive API            | - `GET https://www.googleapis.com/drive/v3/files/{id}/export?mimeType=text/markdown` <br>Auth idéntica a Sheets. <br>Scope: `https://www.googleapis.com/auth/drive.readonly`.                                                                                                                                                                        |
| 3.4 | Gemini API                  | - `POST https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key={API_KEY}` <br>Payload JSON con campo `contents`. <br>Tamaño máx prompt+completion 8192 tokens. <br>Retry: si `HTTP 429` esperar 2^n s con back-off.                                                                                                  |
| 3.5 | ngrok                       | - Comando `ngrok http 8000`. <br>Autenticación: `NGROK_AUTHTOKEN`. <br>Salida de CLI contiene URL pública HTTPS. <br>Webhook registra esa URL; al reiniciar ngrok se debe re-ejecutar `setWebhook`.                                                                                                                                                  |
| 4   | Variables de entorno        | Tabla: `TELEGRAM_TOKEN`, `GOOGLE_SA_KEY_JSON`, `GEMINI_API_KEY`, `NGROK_AUTHTOKEN`.                                                                                                                                                                                                                                                                  |
| 5   | Seguridad y cifrado         | TLS extremo a extremo: ngrok termina HTTPS. <br>Claves almacenadas fuera del repositorio; permisos `600`.                                                                                                                                                                                                                                            |
| 6   | Manejo de errores global    | • `HTTP 4xx` → error de cliente, registrar y abortar. <br>• `HTTP 5xx` → reintento con back-off hasta 3 veces. <br>• Timeout estándar 20 s; abortar después.                                                                                                                                                                                         |
| 7   | Registro (logging)          | Registrar petición, respuesta compacta y código de estado para auditoría; anonimizar contenido sensible.                                                                                                                                                                                                                                             |
| 8   | Versionado y compatibilidad | Versiones mínimas de API, cambios de breaking change monitoreados mensualmente.                                                                                                                                                                                                                                                                      |
| 9   | Historial de cambios        | Fecha, autor, descripción de modificación.                                                                                                                                                                                                                                                                                                           |

Formato sugerido: Markdown con tablas y bloques JSON de ejemplo.
