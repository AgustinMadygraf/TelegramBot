<!DOCTYPE html>
<html>
<head>
    <title>Monitor de ngrok</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .status {
            font-size: 24px;
            margin: 20px 0;
        }
        .running {
            color: green;
        }
        .not-running {
            color: red;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .ngrok-url {
            word-break: break-all;
            margin-top: 20px;
        }
        .message {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Monitor de ngrok</h1>
    
    <div class="status-card">
        <h2>Estado actual:</h2>
        <div class="status {% if ngrok_running %}running{% else %}not-running{% endif %}" id="status-text">
            {% if ngrok_running %}
                ngrok está ejecutándose
            {% else %}
                ngrok no está ejecutándose
            {% endif %}
        </div>
        
        {% if ngrok_url %}
            <div class="ngrok-url" id="ngrok-url">
                <strong>URL pública:</strong> <a href="{{ ngrok_url }}" target="_blank">{{ ngrok_url }}</a>
            </div>
        {% endif %}
        
        {% if not ngrok_running %}
            <form method="post">
                {% csrf_token %}
                <button type="submit" name="start_ngrok">Iniciar ngrok</button>
            </form>
        {% endif %}
    </div>

    <div class="status-card" style="margin-top: 30px;">
        <h2>Configuración del Token de Telegram</h2>
        
        <div class="status {% if env_exists %}running{% else %}not-running{% endif %}">
            Archivo .env: {% if env_exists %}Encontrado{% else %}No encontrado{% endif %}
        </div>
        
        {% if env_exists %}
            <div class="status {% if token_exists %}running{% else %}not-running{% endif %}">
                Token: {% if token_exists %}Configurado{% else %}No configurado{% endif %}
            </div>
            
            {% if token_exists %}
                <div class="status {% if token_valid %}running{% else %}not-running{% endif %}">
                    Validación: {% if token_valid %}Válido{% else %}Inválido{% endif %}
                </div>
                
                <div class="ngrok-url">
                    <strong>Token (parcial):</strong> {{ masked_token }}
                </div>
                
                <div class="ngrok-url">
                    <strong>Información:</strong> {{ token_message }}
                </div>
            {% endif %}
        {% endif %}
    </div>

    {% if token_valid and bot_info %}
    <div class="status-card" style="margin-top: 30px;">
        <h2>Información Detallada del Bot</h2>
        
        <div style="text-align: left; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
            <p><strong>ID del Bot:</strong> {{ bot_info.id }}</p>
            <p><strong>Nombre:</strong> {{ bot_info.first_name }}</p>
            <p><strong>Nombre de Usuario:</strong> @{{ bot_info.username }}</p>
            <p><strong>Es Bot:</strong> {{ bot_info.is_bot }}</p>
            
            {% if bot_info.can_join_groups is not None %}
            <p><strong>Puede unirse a grupos:</strong> {{ bot_info.can_join_groups|yesno:"Sí,No" }}</p>
            {% endif %}
            
            {% if bot_info.can_read_all_group_messages is not None %}
            <p><strong>Puede leer todos los mensajes de grupo:</strong> {{ bot_info.can_read_all_group_messages|yesno:"Sí,No" }}</p>
            {% endif %}
            
            {% if bot_info.supports_inline_queries is not None %}
            <p><strong>Soporta consultas inline:</strong> {{ bot_info.supports_inline_queries|yesno:"Sí,No" }}</p>
            {% endif %}
            
            {% if bot_info.language_code %}
            <p><strong>Código de idioma:</strong> {{ bot_info.language_code }}</p>
            {% endif %}
            
            {% if bot_info.description %}
            <p><strong>Descripción:</strong> {{ bot_info.description }}</p>
            {% endif %}
            
            {% if bot_info.about %}
            <p><strong>Acerca de:</strong> {{ bot_info.about }}</p>
            {% endif %}
        </div>
        
        <div style="margin-top: 20px;">
            <form method="post">
                {% csrf_token %}
                <button type="submit" name="refresh_bot_info" style="background-color: #2196F3;">
                    Actualizar información
                </button>
            </form>
            <div style="font-size: 0.8em; color: #777; margin-top: 10px;">
                La información se actualiza automáticamente cada hora
            </div>
        </div>
    </div>
    {% endif %}

    {% if message %}
    <div class="message">
        {{ message }}
    </div>
    {% endif %}

    <script>
        // Actualizar el estado cada 5 segundos
        setInterval(function() {
            fetch('/check-status/')
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('status-text');
                    const urlContainer = document.getElementById('ngrok-url');
                    
                    if (data.running) {
                        statusEl.textContent = 'ngrok está ejecutándose';
                        statusEl.className = 'status running';
                        
                        if (data.url) {
                            if (!urlContainer) {
                                const div = document.createElement('div');
                                div.id = 'ngrok-url';
                                div.className = 'ngrok-url';
                                div.innerHTML = `<strong>URL pública:</strong> <a href="${data.url}" target="_blank">${data.url}</a>`;
                                document.querySelector('.status-card').appendChild(div);
                            } else {
                                urlContainer.innerHTML = `<strong>URL pública:</strong> <a href="${data.url}" target="_blank">${data.url}</a>`;
                            }
                        }
                        
                        // Ocultar el botón si ngrok está corriendo
                        const form = document.querySelector('form');
                        if (form) form.style.display = 'none';
                    } else {
                        statusEl.textContent = 'ngrok no está ejecutándose';
                        statusEl.className = 'status not-running';
                        
                        // Mostrar el botón si ngrok no está corriendo
                        const form = document.querySelector('form');
                        if (!form) {
                            const newForm = document.createElement('form');
                            newForm.method = 'post';
                            newForm.innerHTML = '{% csrf_token %}<button type="submit" name="start_ngrok">Iniciar ngrok</button>';
                            document.querySelector('.status-card').appendChild(newForm);
                        } else {
                            form.style.display = 'block';
                        }
                        
                        if (urlContainer) {
                            urlContainer.remove();
                        }
                    }
                });
        }, 5000);
    </script>
</body>
</html>