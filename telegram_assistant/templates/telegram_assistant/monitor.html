{% extends "telegram_assistant/base.html" %}

{% block content %}
    <div class="card mb-4">
        <div class="card-body text-center">
            <h5 class="card-title">Estado actual</h5>
            <div class="fs-4 my-3 {% if ngrok_running %}status-running{% else %}status-not-running{% endif %}" id="status-text">
                {% if ngrok_running %}
                    <i class="bi bi-check-circle-fill"></i> ngrok está ejecutándose
                {% else %}
                    <i class="bi bi-x-circle-fill"></i> ngrok no está ejecutándose
                {% endif %}
            </div>
            
            {% if ngrok_url %}
                <div class="alert alert-info ngrok-url" id="ngrok-url">
                    <strong>URL pública:</strong> 
                    <a href="{{ ngrok_url }}" target="_blank" class="text-decoration-none">{{ ngrok_url }}</a>
                </div>
            {% endif %}
            
            {% if not ngrok_running %}
                <form method="post" class="mt-3">
                    {% csrf_token %}
                    <button type="submit" name="start_ngrok" class="btn btn-success btn-lg">
                        Iniciar ngrok
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title text-center">Configuración del Token de Telegram</h5>
            
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="{% if env_exists %}status-running{% else %}status-not-running{% endif %}">
                        Archivo .env: {% if env_exists %}Encontrado{% else %}No encontrado{% endif %}
                    </div>
                </div>
                
                {% if env_exists %}
                <div class="col-md-4">
                    <div class="{% if token_exists %}status-running{% else %}status-not-running{% endif %}">
                        Token: {% if token_exists %}Configurado{% else %}No configurado{% endif %}
                    </div>
                </div>
                
                {% if token_exists %}
                <div class="col-md-4">
                    <div class="{% if token_valid %}status-running{% else %}status-not-running{% endif %}">
                        Validación: {% if token_valid %}Válido{% else %}Inválido{% endif %}
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
            
            {% if token_exists %}
                <div class="mt-3 text-center">
                    <small class="text-muted">
                        <strong>Token (parcial):</strong> {{ masked_token }}<br>
                        <strong>Información:</strong> {{ token_message }}
                    </small>
                </div>
            {% endif %}
        </div>
    </div>

    {% if token_valid and bot_info %}
    <div class="card">
        <div class="card-body">
            <h5 class="card-title text-center">Información Detallada del Bot</h5>
            
            <div class="row">
                <div class="col-md-6">
                    <p><strong>ID del Bot:</strong> {{ bot_info.id }}</p>
                    <p><strong>Nombre:</strong> {{ bot_info.first_name }}</p>
                    <p><strong>Nombre de Usuario:</strong> @{{ bot_info.username }}</p>
                    <p><strong>Es Bot:</strong> {{ bot_info.is_bot|yesno:"Sí,No" }}</p>
                </div>
                <div class="col-md-6">
                    {% if bot_info.can_join_groups is not None %}
                    <p><strong>Puede unirse a grupos:</strong> {{ bot_info.can_join_groups|yesno:"Sí,No" }}</p>
                    {% endif %}
                    
                    {% if bot_info.can_read_all_group_messages is not None %}
                    <p><strong>Puede leer mensajes de grupo:</strong> {{ bot_info.can_read_all_group_messages|yesno:"Sí,No" }}</p>
                    {% endif %}
                    
                    {% if bot_info.supports_inline_queries is not None %}
                    <p><strong>Soporta consultas inline:</strong> {{ bot_info.supports_inline_queries|yesno:"Sí,No" }}</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="text-center mt-3">
                <form method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" name="refresh_bot_info" class="btn btn-primary">
                        Actualizar información
                    </button>
                </form>
                <div class="text-muted mt-2">
                    <small>La información se actualiza automáticamente cada hora</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    <script>
        // El mismo JavaScript que ya tienes, pero actualizado para Bootstrap
        setInterval(function() {
            fetch('/check-status/')
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('status-text');
                    
                    if (data.running) {
                        statusEl.innerHTML = '<i class="bi bi-check-circle-fill"></i> ngrok está ejecutándose';
                        statusEl.className = 'fs-4 my-3 status-running';
                        
                        // Actualizar o agregar la URL de ngrok
                        const urlContainer = document.getElementById('ngrok-url');
                        if (urlContainer) {
                            urlContainer.innerHTML = `<strong>URL pública:</strong> <a href="${data.url}" target="_blank" class="text-decoration-none">${data.url}</a>`;
                        } else {
                            const newUrlContainer = document.createElement('div');
                            newUrlContainer.id = 'ngrok-url';
                            newUrlContainer.className = 'alert alert-info ngrok-url';
                            newUrlContainer.innerHTML = `<strong>URL pública:</strong> <a href="${data.url}" target="_blank" class="text-decoration-none">${data.url}</a>`;
                            document.querySelector('.card.mb-4').appendChild(newUrlContainer);
                        }
                        
                        // Ocultar el botón si ngrok está corriendo
                        const form = document.querySelector('form');
                        if (form) form.style.display = 'none';
                    } else {
                        statusEl.innerHTML = '<i class="bi bi-x-circle-fill"></i> ngrok no está ejecutándose';
                        statusEl.className = 'fs-4 my-3 status-not-running';
                        
                        // Mostrar el botón si ngrok no está corriendo
                        const form = document.querySelector('form');
                        if (!form) {
                            const newForm = document.createElement('form');
                            newForm.method = 'post';
                            newForm.innerHTML = '{% csrf_token %}<button type="submit" name="start_ngrok" class="btn btn-success btn-lg">Iniciar ngrok</button>';
                            document.querySelector('.card.mb-4').appendChild(newForm);
                        } else {
                            form.style.display = 'block';
                        }
                        
                        // Eliminar la URL de ngrok si existe
                        const urlContainer = document.getElementById('ngrok-url');
                        if (urlContainer) {
                            urlContainer.remove();
                        }
                    }
                });
        }, 5000);
    </script>
{% endblock %}